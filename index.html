<!doctype html>
<html lang="nn">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Stadsnamn-quiz</title>
<style>
:root { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
body { margin: 0; background:#0b1220; color:#e5e7eb; }
.wrap { max-width: none; width: min(1400px, 100vw); margin: 0 auto; padding: 14px; }
.card { background: rgba(15,23,42,.9); border: 1px solid rgba(148,163,184,.2); border-radius: 16px; padding: 14px; }
h1 { margin: 0 0 8px; font-size: 22px; }
.row { display: grid; gap: 14px; grid-template-columns: 2.3fr 0.9fr; align-items: start; }
@media (max-width: 820px){.wrap{ padding: 10px; width: 100vw; } .row{ grid-template-columns: 1fr; } .map{ aspect-ratio: 4/3; } }
.meta { display:flex; gap:10px; flex-wrap: wrap; font-size: 13px; opacity:.92; }
.pill { padding: 6px 10px; border-radius: 999px; background: rgba(148,163,184,.12); border: 1px solid rgba(148,163,184,.18); }

.mapWrap { display:flex; flex-direction: column; gap:10px; }
.map {
position: relative;
width: 100%;
aspect-ratio: 16/9;
border-radius: 16px;
overflow: hidden;
border: 1px solid rgba(148,163,184,.2);
background: #0a1020;
}
.tiles { position:absolute; inset:0; transform-origin: 0 0; }
.tile { position:absolute; width: 256px; height: 256px; user-select:none; -webkit-user-drag:none; }
.mask {
position:absolute; left:50%; top:50%;
transform: translate(-50%,-50%);
width: 72px; height: 72px;
border-radius: 999px;
background: rgba(2,6,23,.92);
border: 1px solid rgba(2,6,23,.92);
box-shadow: 0 10px 30px rgba(0,0,0,.35);
pointer-events:none;
}
.attrib {
position:absolute; left:10px; bottom:8px;
font-size: 11px; opacity:.75;
background: rgba(2,6,23,.55);
border: 1px solid rgba(148,163,184,.18);
padding: 4px 8px; border-radius: 999px;
}

.controls { display:flex; gap:12px; flex-wrap: wrap; font-size: 13px; align-items:center; }
.controls label { display:flex; gap:8px; align-items:center; }
input[type="range"] { width: 160px; }

.opts { display: grid; gap: 10px; margin-top: 10px; }
button.opt {
width: 100%;
text-align:left;
padding: 10px 12px;
border-radius: 14px;
background: rgba(30,41,59,.75);
border: 1px solid rgba(148,163,184,.22);
color: #e5e7eb;
font-size: 14px;
cursor: pointer;
}
button.opt:hover { background: rgba(51,65,85,.85); }
button.opt[disabled] { cursor: default; opacity: .85; }
.good { background: rgba(16,185,129,.35) !important; border-color: rgba(16,185,129,.55) !important; }
.bad { background: rgba(244,63,94,.28) !important; border-color: rgba(244,63,94,.55) !important; }
.muted { opacity:.7; }

.actions { display:flex; gap:10px; flex-wrap: wrap; margin-top: 12px; }
.btn {
padding: 10px 12px;
border-radius: 12px;
border: 1px solid rgba(148,163,184,.22);
background: rgba(226,232,240,.92);
color:#0b1220;
font-weight: 700;
cursor:pointer;
}
.btn2 { background: transparent; color:#e5e7eb; font-weight:600; }

.note { margin-top: 8px; font-size: 12px; opacity:.7; }
a { color:#c7d2fe; }

/* Funfact-boks (visast etter svar) */
.factBox {
  margin-top: 10px;
  padding: 10px 12px;
  border-radius: 14px;
  background: rgba(148,163,184,.10);
  border: 1px solid rgba(148,163,184,.22);
  font-size: 13px;
  line-height: 1.35;
}
.factBox b { font-weight: 800; }
.factBox .icon { opacity: .9; margin-right: 6px; }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Stadsnamn-quiz üá≥üá¥</h1>
    <div class="meta">
      <div class="pill" id="progress">Sp√∏rsm√•l 1</div>
      <div class="pill" id="score">Poeng 0</div>
      <div class="pill" id="fylke">Fylke: ‚Äì</div>
    </div>
  </div>

  <div style="height:12px"></div>

  <div class="row">
    <div class="card mapWrap">
      <div class="map" aria-label="Kartutsnitt">
        <div class="tiles" id="tiles"></div>
        <div class="mask" id="mask"></div>
        <div class="attrib">
          Kart: ¬© <a href="https://www.openstreetmap.org/copyright" target="_blank" rel="noreferrer">OpenStreetMap</a>
        </div>
      </div>

      <div class="controls">
        <label>Zoom
          <input id="zoom" type="range" min="6" max="12" step="1" value="9">
          <span id="zoomVal">9</span>
        </label>
        <label>Mask
          <input id="maskSize" type="range" min="28" max="140" step="2" value="88">
          <span id="maskVal">88px</span>
        </label>
        <button class="btn btn2" id="newTiles">Oppdater kart</button>
      </div>

      <div class="note">
        NB: Ekte OSM-kartfliser (treng internett). Om du ser tomme ruter: vent litt eller trykk ‚ÄúOppdater kart‚Äù.
      </div>
    </div>

    <div class="card">
      <div style="font-weight:800; font-size:16px;">Kva heiter denne staden?</div>
      <div class="muted" style="margin-top:6px">
        Vel eitt av fire alternativ (fr√• same fylke eller n√¶romr√•det).
      </div>
      <div class="opts" id="opts"></div>

      <!-- Funfact (visast etter svar) -->
      <div id="factBox" class="factBox" style="display:none;"></div>

      <div class="actions">
        <button class="btn" id="restart">Start p√• nytt</button>
        <button class="btn btn2" id="skip">Hopp over</button>
      </div>

      <div class="note">
        Tips: Zoom ned for lettare, zoom opp for vanskelegare. Mask kan justerast om labels ‚Äústikk ut‚Äù.
      </div>
    </div>
  </div>
</div>

<script>
const QUESTIONS_PER_ROUND = 30;

// OSM Standard tiles
const TILE_URL = (z, x, y) => `https://tile.openstreetmap.org/${z}/${x}/${y}.png`;
const TILE_SIZE = 256;

// Sm√•/mellomstore stader med ca-koordinatar + funfact (ALLTID)
const PLACES = [
  // Finnmark
  { name:"Kirkenes", fylke:"Finnmark", lat:69.7271, lon:30.0458,
    fact:"Byen har tilknyting til langrennsl√∏paren Vegard Ulvang, som voks opp i S√∏r-Varanger." },
  { name:"Lakselv", fylke:"Finnmark", lat:70.0516, lon:24.9731,
    fact:"Ligg ved Banak-omr√•det og har vore eit viktig knutepunkt i indre Finnmark." },
  { name:"Vads√∏", fylke:"Finnmark", lat:70.0735, lon:29.7494,
    fact:"Heimstaden til fotballspelaren Morten Gamst Pedersen og skodespelaren Stig Henrik Hoff." },
  { name:"Vard√∏", fylke:"Finnmark", lat:70.3705, lon:31.1107,
    fact:"Heim til Vard√∏hus festning, Noregs nordlegaste festningsanlegg." },
  { name:"Honningsv√•g",fylke:"Finnmark", lat:70.9821, lon:25.9704,
    fact:"Viktig hamn og utgangspunkt for reiser mot Nordkapp-omr√•det." },
  { name:"Karasjok", fylke:"Finnmark", lat:69.4719, lon:25.5110,
    fact:"Eit tydeleg sentrum for samisk kultur og institusjonar i Noreg." },
  { name:"Kj√∏llefjord", fylke:"Finnmark", lat:70.9452, lon:27.3507,
    fact:"V√™rhardt fiskev√¶r p√• Nordkyn, der havet har prega kvardagen lenge." },
  { name:"Mehamn", fylke:"Finnmark", lat:71.0340, lon:27.8513,
    fact:"Eit av dei nordlegaste fiskev√¶ra p√• fastlandet, heilt ut mot Barentshavet." },
  { name:"B√•tsfjord", fylke:"Finnmark", lat:70.6340, lon:29.7174,
    fact:"Sterkt prega av fiskeri og sj√∏matindustri, med aktiv hamn." },
  { name:"Tana bru", fylke:"Finnmark", lat:70.1994, lon:28.1903,
    fact:"Ligg ved Tanaelva i eit stort elvedalf√∏re, eit viktig ferdselsomr√•de." },
  { name:"Berlev√•g", fylke:"Finnmark", lat:70.8574, lon:29.0866,
    fact:"Lita kystbygd heilt ut mot Barentshavet, kjend for t√∏ft klima." },
  { name:"Kautokeino", fylke:"Finnmark", lat:69.0120, lon:23.0417,
    fact:"Kjent for samisk kultur og sterke tradisjonar knytt til reindrift og spr√•k." },
  { name:"Gamvik", fylke:"Finnmark", lat:71.0419, lon:27.8518,
    fact:"Ligg p√• Nordkinn-halv√∏ya, i eit av dei mest nordlege busettingsomr√•da p√• fastlandet." },
  { name:"Bug√∏ynes", fylke:"Finnmark", lat:69.9608, lon:29.9758,
    fact:"Lita kystbygd i aust-Finnmark med s√¶rprega lokalkultur i grenseomr√•det." },

  // Troms
  { name:"Finnsnes", fylke:"Troms", lat:69.2307, lon:18.0084,
    fact:"Eit viktig regionsenter og ofte kalla porten til Senja." },
  { name:"Setermoen", fylke:"Troms", lat:68.8561, lon:18.3481,
    fact:"Kjent som milit√¶rstad og knutepunkt i indre Troms." },
  { name:"Bardufoss", fylke:"Troms", lat:69.0558, lon:18.5365,
    fact:"Sterkt knytt til flyplass og milit√¶r tilstedev√¶relse, og fungerer som regionalt knutepunkt." },
  { name:"Sj√∏vegan", fylke:"Troms", lat:68.8756, lon:17.8523,
    fact:"Fjordbygd i indre Troms, omgitt av bratte fjell og fjordlandskap." },
  { name:"Skjerv√∏y", fylke:"Troms", lat:70.0286, lon:20.9713,
    fact:"√òysamfunn med sterk maritim tradisjon og kystn√¶rt levevis." },
  { name:"Hansnes", fylke:"Troms", lat:69.9686, lon:19.6230,
    fact:"Viktig ferje- og b√•tknutepunkt i √∏yriket nord for Troms√∏." },
  { name:"Storslett", fylke:"Troms", lat:69.7707, lon:21.0261,
    fact:"Regionsenter i Nordreisa, der dal og fjord m√∏test." },
  { name:"Lyngseidet", fylke:"Troms", lat:69.5767, lon:20.2185,
    fact:"Ligg ved Lyngenfjorden med kort veg til alpine Lyngsalpane." },
  { name:"Botnhamn", fylke:"Troms", lat:69.5142, lon:17.8991,
    fact:"Kjent som ferjeleie og eit praktisk utgangspunkt for √• utforske Senja." },
  { name:"Burfjord", fylke:"Troms", lat:69.9426, lon:21.2131,
    fact:"Fjordbygd i Kv√¶nangen, med dramatiske fjell rett opp fr√• fjorden." },
  { name:"Moen", fylke:"Troms", lat:69.1300, lon:18.6100,
    fact:"Ligg i M√•lselvdalen og fungerer som lokalt senter for dalf√∏ret." },
  { name:"S√∏rkjosen", fylke:"Troms", lat:69.7867, lon:20.9597,
    fact:"Knytt til reise og trafikk i Nordreisa, og ligg i eit dal- og fjordlandskap." },
  { name:"Botnhamn (Senja)", fylke:"Troms", lat:69.5142, lon:17.8991,
    fact:"Same omr√•det som Botnhamn; kjend for ferjesamband og kystn√¶r natur p√• Senja." },

  // Nordland
  { name:"Fauske", fylke:"Nordland", lat:67.2591, lon:15.3917,
    fact:"Eit sentralt knutepunkt i Salten, ofte brukt som inngang til indre Nordland." },
  { name:"Rognan", fylke:"Nordland", lat:67.1008, lon:15.3906,
    fact:"Tettstad i Saltdal, i eit dalf√∏re som bind saman fjellomr√•de og fjord." },
  { name:"Leknes", fylke:"Nordland", lat:68.1475, lon:13.6119,
    fact:"Eit av hovudsentra i Lofoten, med mykje handel og trafikk." },
  { name:"Svolv√¶r", fylke:"Nordland", lat:68.2341, lon:14.5683,
    fact:"Kjent som eit viktig sentrum i Lofoten, med reiseliv og fiskeri tett p√•." },
  { name:"Andenes", fylke:"Nordland", lat:69.3143, lon:16.1194,
    fact:"Knytt til kyst, fiskeri og aktivitet p√• And√∏ya, og er kjend for sitt havn√¶re landskap." },
  { name:"Ballangen", fylke:"Nordland", lat:68.3426, lon:16.8316,
    fact:"Fjordbygd ved Ofotfjorden, med fjell og fjord tett p√•." },
  { name:"Drag", fylke:"Nordland", lat:68.0812, lon:15.6027,
    fact:"Kyststad i fjordlandskap, lenge kjent som transportpunkt i omr√•det." },
  { name:"Reine", fylke:"Nordland", lat:67.9327, lon:13.0892,
    fact:"Ikonisk fiskev√¶r i Lofoten, omgitt av spisse fjell og smale sund." },
  { name:"Inndyr", fylke:"Nordland", lat:67.0335, lon:14.0286,
    fact:"Tettstad i Gildesk√•l, med typisk kystlandskap og √∏yrike rundt." },
  { name:"Hemnesberget", fylke:"Nordland", lat:66.2205, lon:13.6212,
    fact:"Kyststad ved fjordarmar, kjend for trehusmilj√∏ og fjordutsyn." },
  { name:"Hamar√∏yhamn", fylke:"Nordland", lat:68.0810, lon:15.7790,
    fact:"Ligg i eit nordlandsk kyst- og √∏ylandskap i Hamar√∏y-omr√•det." },
  { name:"Myre", fylke:"Nordland", lat:68.9156, lon:15.0935,
    fact:"Viktig fiske- og servicesenter i Vester√•len, prega av sj√∏matn√¶ringa." },
  { name:"Reip√•", fylke:"Nordland", lat:66.8218, lon:13.5708,
    fact:"Ligg i Mel√∏y-omr√•det, i overgangen mellom kystnatur og fjell i bakgrunnen." },

  // Tr√∏ndelag
  { name:"R√∏ros", fylke:"Tr√∏ndelag", lat:62.5747, lon:11.3841,
    fact:"Historisk bergstad bygd p√• koparutvinning og gruvekultur." },
  { name:"Oppdal", fylke:"Tr√∏ndelag", lat:62.5941, lon:9.6910,
    fact:"Fjellkommune og base for friluftsliv og vinteraktivitet n√¶r store fjellomr√•de." },
  { name:"St√∏ren", fylke:"Tr√∏ndelag", lat:63.0484, lon:10.2811,
    fact:"Regionsenter i Gauldalen, der viktige dalf√∏re og vegar m√∏test." },
  { name:"Brekstad", fylke:"Tr√∏ndelag", lat:63.7136, lon:9.6636,
    fact:"Kystby p√• √òrlandet, tett knytt til kystkultur og aktivitet knytt til flyplassregionen." },
  { name:"√Ö (Inder√∏y)", fylke:"Tr√∏ndelag", lat:63.9610, lon:11.3055,
    fact:"Lita bygd i jordbruks- og fjordlandskap ved Trondheimsfjorden." },
  { name:"Rissa", fylke:"Tr√∏ndelag", lat:63.5834, lon:10.0063,
    fact:"Del av Fosen-regionen med kyst- og fjordpreg og lokalt n√¶ringsliv knytt til omr√•det." },
  { name:"Lensvik", fylke:"Tr√∏ndelag", lat:63.5179, lon:9.8153,
    fact:"Kystbygd ved Trondheimsfjorden, historisk knytt til sj√∏transport over fjorden." },
  { name:"B√∏rsa", fylke:"Tr√∏ndelag", lat:63.1716, lon:10.2407,
    fact:"Bygdesenter n√¶r fjorden, i eit landskap prega av jordbruk og fjordn√¶r busetnad." },
  { name:"Kyrks√¶ter√∏ra", fylke:"Tr√∏ndelag", lat:63.2896, lon:8.7357,
    fact:"Regionsenter med industrihistorie, i overgangen mellom fjord og innland." },
  { name:"Sn√•sa", fylke:"Tr√∏ndelag", lat:64.2450, lon:12.3770,
    fact:"Kjent for natur og n√¶rleik til verneomr√•de, og har √≤g s√∏rsamisk tilknyting." },
  { name:"√Ösen", fylke:"Tr√∏ndelag", lat:63.6170, lon:10.9390,
    fact:"Bygd i Levanger-omr√•det, i eit tradisjonelt jordbrukslandskap." },
  { name:"R√∏rvik", fylke:"Tr√∏ndelag", lat:64.8624, lon:11.2408,
    fact:"Viktig kysthamn og sj√∏matby, der fiskeri og transport har prega utviklinga." },

  // Vestland
  { name:"Odda", fylke:"Vestland", lat:60.0697, lon:6.5457,
    fact:"Hardanger-stad med industrihistorie og dramatisk fjord- og fjellandskap." },
  { name:"Norheimsund", fylke:"Vestland", lat:60.3703, lon:6.1452,
    fact:"Knutepunkt ved Hardangerfjorden, i eit klassisk fjordbygdelandskap." },
  { name:"M√•l√∏y", fylke:"Vestland", lat:61.9354, lon:5.1136,
    fact:"Kystby ytterst mot havet, prega av sj√∏, vind og maritim n√¶ring." },
  { name:"Rosendal", fylke:"Vestland", lat:59.9867, lon:6.0115,
    fact:"Kjent for kulturmilj√∏ og fjordlandskapet i Sunnhordland." },
  { name:"Aurland", fylke:"Vestland", lat:60.9056, lon:7.1876,
    fact:"Fjordbygd ved Aurlandsfjorden, n√¶r noko av Noregs mest kjende fjordnatur." },
  { name:"Fl√•m", fylke:"Vestland", lat:60.8623, lon:7.1148,
    fact:"Sterkt knytt til reiseliv og Fl√•msbana, eit av dei mest kjende fjord-knutepunkta." },
  { name:"Vik√∏yri", fylke:"Vestland", lat:61.0873, lon:6.5787,
    fact:"Tettstad ved Sognefjorden, med fjordbygdkultur og historiske bygdemilj√∏." },
  { name:"Fitjar", fylke:"Vestland", lat:59.9190, lon:5.3171,
    fact:"Kyst- og √∏ykommune i Sunnhordland, med mykje sj√∏ og √∏yar rundt." },
  { name:"Nordfjordeid", fylke:"Vestland", lat:61.9055, lon:6.0020,
    fact:"Ligg inst i Nordfjord, omgitt av fjord og fjell med gode ferdsels√•rer." },
  { name:"Masfjordnes", fylke:"Vestland", lat:60.7990, lon:5.2910,
    fact:"Fjordbygd ved Masfjorden, i typisk bratt vestlandsnatur." },
  { name:"L√¶rdals√∏yri", fylke:"Vestland", lat:61.1006, lon:7.4829,
    fact:"Ligg der dal og fjord m√∏test ved Sognefjorden, med viktig transportrolle i regionen." },
  { name:"Sk√•nevik", fylke:"Vestland", lat:59.9997, lon:5.7597,
    fact:"Fjordbygd i Sunnhordland med roleg fjordmilj√∏ og bratte lier rundt." },

  // Rogaland
  { name:"Sauda", fylke:"Rogaland", lat:59.6509, lon:6.3541,
    fact:"Industristad inst i Ryfylke, omgitt av bratte fjell og fjordarmar." },
  { name:"J√∏rpeland", fylke:"Rogaland", lat:58.9861, lon:6.0406,
    fact:"Kjent som baseomr√•de for turar mot Lysefjorden og Preikestolen-omr√•det." },
  { name:"N√¶rb√∏", fylke:"Rogaland", lat:58.6642, lon:5.6377,
    fact:"Typisk J√¶ren-stad i eit av landets mest jordbruksdominerte landskap." },
  { name:"Skudeneshavn",fylke:"Rogaland",lat:59.1482, lon:5.2638,
    fact:"Kjent for historisk trehusmilj√∏ og kystbykultur p√• Karm√∏y." },
  { name:"Vikes√•", fylke:"Rogaland", lat:58.6351, lon:6.0935,
    fact:"Bygdesenter i innlandet, omgitt av heiar, vatn og skog." },
  { name:"√Ölg√•rd", fylke:"Rogaland", lat:58.7645, lon:5.8537,
    fact:"Tettstad med sterk vekst og pendling, n√¶r overgangen til heiane og fjellomr√•da." },
  { name:"Varhaug", fylke:"Rogaland", lat:58.6176, lon:5.6443,
    fact:"J√¶rsk tettstad n√¶r kysten, i flatt og ope jordbrukslandskap." },
  { name:"Sirev√•g", fylke:"Rogaland", lat:58.5022, lon:5.5735,
    fact:"Kyststad med hamn og maritimt preg, tett p√• havet." },
  { name:"Vigrestad", fylke:"Rogaland", lat:58.5710, lon:5.6900,
    fact:"Ligg midt i jordbruksbeltet p√• J√¶ren, i eit ope og flatt kulturlandskap." },
  { name:"Suldalsosen", fylke:"Rogaland", lat:59.4870, lon:6.2680,
    fact:"Tettstad inst i Ryfylke, der fjord og dalf√∏re m√∏test." },
  { name:"√Ökra", fylke:"Rogaland", lat:59.2600, lon:5.1900,
    fact:"Tettstad p√• Karm√∏y med kystn√¶rt preg og tett busetnad." },
  { name:"Egersund", fylke:"Rogaland", lat:58.4513, lon:5.9997,
    fact:"Har M√•netorget laga av anortositt (bergart ogs√• funnen p√• m√•nen), og er ein historisk kystby." },

  // Agder
  { name:"Flekkefjord",fylke:"Agder", lat:58.2973, lon:6.6609,
    fact:"Historisk kystby med trehusmilj√∏ og sterk sj√∏fart- og handelskultur." },
  { name:"Farsund", fylke:"Agder", lat:58.0959, lon:6.8031,
    fact:"Kystby p√• Lista-omr√•det, prega av hav, vind og sj√∏fart." },
  { name:"Lyngdal", fylke:"Agder", lat:58.1379, lon:7.0766,
    fact:"Bygde- og regionsenter ved Lyngdalselva, med tydeleg handelsrolle." },
  { name:"Evje", fylke:"Agder", lat:58.5848, lon:7.7997,
    fact:"Porten inn i Setesdal, tett knytt til dalf√∏re og innlandsnatur." },
  { name:"Birkeland", fylke:"Agder", lat:58.3335, lon:8.2334,
    fact:"Bygdesenter i overgangen fr√• kyst til indre Agder, omgitt av skog og dalterreng." },
  { name:"Byglandsfjord", fylke:"Agder", lat:58.9218, lon:7.7684,
    fact:"Ligg ved Byglandsfjorden i Setesdal, omgitt av innsj√∏- og dalf√∏relandskap." },
  { name:"Tvedestrand", fylke:"Agder", lat:58.6234, lon:8.9274,
    fact:"S√∏rlandsby med kvite trehus og tydeleg sm√•bypreg ved sj√∏en." },
  { name:"H√¶geland", fylke:"Agder", lat:58.2364, lon:7.9334,
    fact:"Innlandsbygd i skog- og √•slandskap, roleg og naturpreget omr√•de." },
  { name:"Valle", fylke:"Agder", lat:59.2050, lon:7.5350,
    fact:"Klassisk Setesdal-bygd med tradisjonar og fjell- og daln√¶r natur." },
  { name:"√Ömli", fylke:"Agder", lat:58.7670, lon:8.4930,
    fact:"Innlandsbygd med mykje skog, vatn og elven√¶r natur." },
  { name:"S√∏gne", fylke:"Agder", lat:58.0930, lon:7.8070,
    fact:"Kystn√¶rt s√∏rlandsomr√•de med skjergard og b√•tliv vest for Kristiansand." },
  { name:"Tonstad", fylke:"Agder", lat:58.6620, lon:6.7150,
    fact:"Tettstad i Sirdal, omgitt av heiar og fjellterreng." },

  // Innlandet
  { name:"Otta", fylke:"Innlandet",lat:61.7716, lon:9.5376,
    fact:"Knutepunkt i Gudbrandsdalen, der dalen m√∏ter fjellvegane vidare vest og nord." },
  { name:"Fagernes", fylke:"Innlandet",lat:60.9854, lon:9.2320,
    fact:"Regionsenter i Valdres, tett p√• fjellomr√•de og dalf√∏re." },
  { name:"Dokka", fylke:"Innlandet",lat:60.8361, lon:10.0683,
    fact:"Tettstad i Nordre Land, i eit innlandslandskap med skog og √•sar." },
  { name:"Trysil", fylke:"Innlandet",lat:61.3137, lon:12.2647,
    fact:"Kjent for ski- og vinterturisme og store skog- og fjellomr√•de." },
  { name:"V√•g√•mo", fylke:"Innlandet", lat:61.8755, lon:9.0946,
    fact:"Bygdesenter i Ottadalen, n√¶r store fjell- og nasjonalparklandskap." },
  { name:"Ringebu", fylke:"Innlandet", lat:61.5293, lon:10.1354,
    fact:"Gudbrandsdalsbygd med lang jordbrukstradisjon og kulturminne i dalf√∏ret." },
  { name:"Brandbu", fylke:"Innlandet", lat:60.4194, lon:10.6475,
    fact:"Hadelands-tettstad med jordbruk og kort veg til Oslo-regionen." },
  { name:"Tolga", fylke:"Innlandet", lat:62.4071, lon:11.0204,
    fact:"√òsterdalsbygd prega av skog, elv og fjelln√¶r natur." },
  { name:"Skj√•k", fylke:"Innlandet", lat:61.8840, lon:8.2660,
    fact:"Fjellkommune med mykje h√∏gfjell og eit t√∏rt innlandspreg samanlikna med kysten." },
  { name:"Engerdal", fylke:"Innlandet", lat:61.7570, lon:11.9700,
    fact:"Fjell- og skogkommune med store natur- og friluftsomr√•de." },
  { name:"Vestre Slidre", fylke:"Innlandet", lat:61.0860, lon:9.0780,
    fact:"Valdres-kommune med dalf√∏re og fjellterreng, mykje friluftsliv." },
  { name:"Rendalen", fylke:"Innlandet", lat:61.8910, lon:11.0720,
    fact:"Stor kommune med skog- og dalf√∏relandskap og roleg innlandsnatur." },

  // Viken
  { name:"√Örnes", fylke:"Viken", lat:60.1230, lon:11.4636,
    fact:"Lokalt knutepunkt p√• Romerike, i omr√•de knytt til Glomma og ferdsel austover." },
  { name:"Mysen", fylke:"Viken", lat:59.5530, lon:11.3276,
    fact:"Senter i Indre √òstfold, omgitt av jordbrukslandskap og sm√•bystruktur." },
  { name:"Rakkestad", fylke:"Viken", lat:59.4257, lon:11.3392,
    fact:"√òstfold-tettstad der skog og jordbruk pregar landskapet rundt." },
  { name:"Vikersund", fylke:"Viken", lat:59.9648, lon:9.9915,
    fact:"Kjent for Vikersundbakken og skiflygingsarrangement p√• verdsniv√•." },
  { name:"R√∏yken", fylke:"Viken", lat:59.7402, lon:10.4116,
    fact:"Del av Oslo-regionen med mykje pendling og variert kyst- og innlandsterreng." },
  { name:"Lierbyen", fylke:"Viken", lat:59.7856, lon:10.2456,
    fact:"Senter i Lier, tett knytt til Drammensomr√•det og jordbruksbygdene rundt." },
  { name:"Nesbyen", fylke:"Viken", lat:60.5695, lon:9.1020,
    fact:"Hallingdal-tettstad i dalf√∏re, med fjell i alle retningar." },
  { name:"Aurskog", fylke:"Viken", lat:59.9269, lon:11.5694,
    fact:"Skog- og innsj√∏preg i indre Romerike, i eit landskap prega av friluftsliv." },
  { name:"R√∏dberg", fylke:"Viken", lat:60.2660, lon:8.9450,
    fact:"Tettstad i fjellkommunen Nore og Uvdal, n√¶r h√∏gfjell og dalf√∏re." },
  { name:"Aremark", fylke:"Viken", lat:59.2200, lon:11.6950,
    fact:"Grensen√¶rt innlandsomr√•de med mykje skog og innsj√∏landskap." },
  { name:"Hol", fylke:"Viken", lat:60.6150, lon:8.3000,
    fact:"H√∏gfjells- og dalomr√•de i Hallingdal, med tydeleg vinter- og fjellpreg." },
  { name:"Son", fylke:"Viken", lat:59.5230, lon:10.6840,
    fact:"Kyststad ved Oslofjorden med sm√•bypreg og b√•tliv." },

  // Dr√∏bak
  { name:"Dr√∏bak", fylke:"Viken", lat:59.6670, lon:10.6330,
    fact:"Fjordby ved Oslofjorden, kjend for n√¶rleiken til Oscarsborg festning." },
];

function groupBy(arr, key){
  return arr.reduce((acc,x)=>((acc[x[key]] ??= []).push(x), acc), {});
}
function shuffle(a){
  a = a.slice();
  for (let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function clamp(n, lo, hi){ return Math.max(lo, Math.min(hi, n)); }

// ---------- Pixel-presis Web Mercator ----------
function latLonToWorldPx(lat, lon, z){
  const n = Math.pow(2, z);
  const x = (lon + 180) / 360 * n * TILE_SIZE;

  const latClamped = clamp(lat, -85.05112878, 85.05112878);
  const rad = latClamped * Math.PI / 180;
  const y = (1 - Math.log(Math.tan(rad) + 1/Math.cos(rad)) / Math.PI) / 2 * n * TILE_SIZE;

  return { x, y, n };
}

function renderTilesPrecise(lat, lon, z){
  const tilesEl = document.getElementById("tiles");
  tilesEl.innerHTML = "";

  const mapEl = tilesEl.parentElement;
  const rect = mapEl.getBoundingClientRect();

  const cols = 5, rows = 4;
  const totalW = cols * TILE_SIZE, totalH = rows * TILE_SIZE;
  const scale = Math.max(rect.width / totalW, rect.height / totalH);

  tilesEl.style.width = totalW + "px";
  tilesEl.style.height = totalH + "px";

  const wp = latLonToWorldPx(lat, lon, z);
  const nTiles = wp.n;

  const cx = Math.floor(wp.x / TILE_SIZE);
  const cy = Math.floor(wp.y / TILE_SIZE);

  let startX = cx - Math.floor(cols / 2);
  let startY = clamp(cy - Math.floor(rows / 2), 0, nTiles - rows);

  const startWorldX = startX * TILE_SIZE;
  const startWorldY = startY * TILE_SIZE;

  const offsetX = wp.x - startWorldX;
  const offsetY = wp.y - startWorldY;

  const targetX = (rect.width / scale) / 2;
  const targetY = (rect.height / scale) / 2;

  const tx = targetX - offsetX;
  const ty = targetY - offsetY;

  tilesEl.style.transform = `scale(${scale}) translate(${tx}px, ${ty}px)`;

  const maxY = nTiles - 1;
  for (let r = 0; r < rows; r++){
    for (let c = 0; c < cols; c++){
      const rawX = startX + c;
      const x = ((rawX % nTiles) + nTiles) % nTiles;
      const y = clamp(startY + r, 0, maxY);

      const img = document.createElement("img");
      img.className = "tile";
      img.alt = "";
      img.loading = "eager";
      img.decoding = "async";
      img.src = TILE_URL(z, x, y);
      img.style.left = (c * TILE_SIZE) + "px";
      img.style.top = (r * TILE_SIZE) + "px";
      tilesEl.appendChild(img);
    }
  }
}

// ---------- N√¶romr√•de (avstand) ----------
function haversineKm(a, b){
  const R = 6371;
  const toRad = d => d * Math.PI / 180;
  const dLat = toRad(b.lat - a.lat);
  const dLon = toRad(b.lon - a.lon);
  const lat1 = toRad(a.lat);
  const lat2 = toRad(b.lat);

  const s = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(s), Math.sqrt(1-s));
  return R * c;
}

// ---------- Quiz ----------
const byFylke = groupBy(PLACES, "fylke");
let questions = [];
let idx = 0;
let score = 0;
let locked = false;

function buildOptionsForPlace(p){
  const opts = [p.name];
  const used = new Set(opts);

  // Same fylke f√∏rst
  const same = shuffle((byFylke[p.fylke] || []).filter(x => x.name !== p.name));
  for (const cand of same){
    if (opts.length >= 4) break;
    if (!used.has(cand.name)){
      opts.push(cand.name);
      used.add(cand.name);
    }
  }

  // Fyll p√• med n√¶raste (uansett fylke)
  if (opts.length < 4){
    const sortedByNear = PLACES
      .filter(x => x.name !== p.name && !used.has(x.name))
      .map(x => ({ x, d: haversineKm(p, x) }))
      .sort((a,b) => a.d - b.d)
      .map(o => o.x);

    for (const cand of sortedByNear){
      if (opts.length >= 4) break;
      opts.push(cand.name);
      used.add(cand.name);
    }
  }

  return shuffle(opts);
}

function buildQuestions(){
  // 30 heilt tilfeldige stadar kvar runde (utan duplikat i same runde)
  const base = shuffle(PLACES).slice(0, Math.min(QUESTIONS_PER_ROUND, PLACES.length));

  return base.map(p => ({
    correct: p.name,
    fylke: p.fylke,
    options: buildOptionsForPlace(p),
    lat: p.lat,
    lon: p.lon,
    fact: p.fact
  }));
}

function updateMapForCurrent(){
  const q = questions[idx];
  const z = parseInt(document.getElementById("zoom").value, 10);
  renderTilesPrecise(q.lat, q.lon, z);
}

function hideFact(){
  const factEl = document.getElementById("factBox");
  factEl.style.display = "none";
  factEl.textContent = "";
}

function showFactForCorrect(q){
  const factEl = document.getElementById("factBox");
  factEl.innerHTML = `<span class="icon">‚ÑπÔ∏è</span><b>${q.correct}:</b> ${q.fact}`;
  factEl.style.display = "block";
}

function render(){
  const q = questions[idx];
  document.getElementById("progress").textContent = `Sp√∏rsm√•l ${idx+1} / ${questions.length}`;
  document.getElementById("score").textContent = `Poeng ${score}`;
  document.getElementById("fylke").textContent = `Fylke: ${q.fylke}`;

  const optsEl = document.getElementById("opts");
  optsEl.innerHTML = "";
  locked = false;
  hideFact();

  q.options.forEach(opt=>{
    const b = document.createElement("button");
    b.className = "opt";
    b.textContent = opt;
    b.onclick = () => pick(opt);
    optsEl.appendChild(b);
  });

  updateMapForCurrent();
}

function pick(opt){
  if (locked) return;
  locked = true;
  const q = questions[idx];
  const buttons = [...document.querySelectorAll("button.opt")];

  buttons.forEach(btn=>{
    btn.disabled = true;
    if (btn.textContent === q.correct) btn.classList.add("good");
    if (btn.textContent === opt && opt !== q.correct) btn.classList.add("bad");
    if (btn.textContent !== q.correct && btn.textContent !== opt) btn.classList.add("muted");
  });

  if (opt === q.correct) score++;

  // Vis alltid fact for riktig svar (uavhengig av rett/feil)
  showFactForCorrect(q);

  setTimeout(()=>{
    idx++;
    if (idx >= questions.length){
      alert(`Ferdig! Poeng: ${score} / ${questions.length}`);
      restart();
    } else {
      render();
    }
  }, 900);
}

function restart(){
  questions = buildQuestions();
  idx = 0;
  score = 0;
  render();
}

// UI wires
const zoomEl = document.getElementById("zoom");
const zoomVal = document.getElementById("zoomVal");
zoomEl.addEventListener("input", () => zoomVal.textContent = zoomEl.value);
zoomEl.addEventListener("change", updateMapForCurrent);

const maskEl = document.getElementById("maskSize");
const maskVal = document.getElementById("maskVal");
const mask = document.getElementById("mask");
function applyMask(){
  const px = parseInt(maskEl.value, 10);
  mask.style.width = px + "px";
  mask.style.height = px + "px";
  maskVal.textContent = px + "px";
}
maskEl.addEventListener("input", applyMask);
applyMask();

document.getElementById("newTiles").onclick = updateMapForCurrent;
document.getElementById("restart").onclick = restart;
document.getElementById("skip").onclick = () => {
  if (locked) return;
  idx++;
  if (idx >= questions.length) { alert(`Ferdig! Poeng: ${score} / ${questions.length}`); restart(); }
  else render();
};

// Initial
restart();
</script>
</body>
</html>
